<!doctype html>
<html>
<head>
    <title>VLRAG Clinical Search</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            padding: 2rem;
            max-width: 800px;
            margin: 0 auto;
            background-color: #f9f9f9;
        }

        h1 { color: #333; }

        .search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 2rem;
        }

        input {
            flex-grow: 1;
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        button {
            padding: 0.8rem 1.5rem;
            background-color: #0070f3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }

        button:hover { background-color: #005bb5; }

        /* ===== Results list UI ===== */

        .results-list {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .result-card {
            background: white;
            border: 1px solid #e1e1e1;
            border-radius: 12px;
            padding: 1.2rem 1.3rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* ✅ Hover/interaction polish + whole-card clickable */
        .result-card {
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        .result-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
        }

        
        .result-card a {
            text-decoration: none;
        }

        .result-card a:hover {
            text-decoration: underline;
        }

        .result-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 8px;
        }

        .result-title-link {
            font-weight: 700;
            font-size: 1.05rem;
            color: #2c3e50;
            text-decoration: none;
            line-height: 1.2;
        }

        .result-title-link:hover {
            text-decoration: underline;
        }

        .source-link {
            font-size: 0.9rem;
            color: #0070f3;
            text-decoration: none;
            font-weight: 500;
            white-space: nowrap;
        }

        .source-link:hover { text-decoration: underline; }

        .result-meta {
            color: #666;
            font-size: 0.92rem;
            margin-bottom: 10px;
        }

        .result-snippet {
            color: #333;
            line-height: 1.5;
            margin: 0;
        }

        .badge {
            display: inline-block;
            padding: 0.15rem 0.45rem;
            border: 1px solid #e6e6e6;
            border-radius: 999px;
            font-size: 0.8rem;
            color: #555;
            background: #fafafa;
            margin-left: 8px;
        }
    </style>
</head>

<body>
    <h1>VLRAG Clinical Search</h1>

    <div class="search-container">
        <input id="q" placeholder="Ask a clinical question (e.g. 'Treatment for diabetes')" onkeypress="handleEnter(event)" />
        <button onclick="search()">Search</button>
    </div>

    <div id="results"></div>

    <script>
        function handleEnter(e) {
            if (e.key === 'Enter') search();
        }

        function escapeHtml(s) {
            return String(s ?? "")
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;")
                .replaceAll("'", "&#039;");
        }

        function sourceFromUrl(url) {
            try {
                return new URL(url).hostname.replace("www.", "");
            } catch {
                return "";
            }
        }

        function makeSnippet(text, maxChars = 220) {
            const cleaned = String(text ?? "").replace(/\s+/g, " ").trim();
            if (!cleaned) return "";
            const parts = cleaned.split(/(?<=[.!?])\s+/);
            const snippet = parts.slice(0, 2).join(" ");
            return snippet.length > maxChars
                ? snippet.slice(0, maxChars).trim() + "…"
                : snippet;
        }

        async function search() {
            const q = document.getElementById("q").value;
            const resultsDiv = document.getElementById("results");

            if (!q.trim()) return;

            
            resultsDiv.innerHTML = '<p style="color: #666;">Searching guidelines...</p>';

            try {
                const res = await fetch("/search", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ query: q, top_k: 5 })
                });

                const data = await res.json();
                resultsDiv.innerHTML = "";

                if (!data.results || data.results.length === 0) {
                    resultsDiv.innerHTML = '<p>No relevant guidelines found.</p>';
                    return;
                }

                let html = `<div class="results-list">`;

                data.results.slice(0, 5).forEach((r, idx) => {
                    const url = r.url || "";
                    const title = r.title || r.document_title || r.section_heading || `Result ${idx + 1}`;
                    const source = url ? sourceFromUrl(url) : "";
                    const snippet = makeSnippet(r.content);

                    const titleHtml = url
                        ? `<a class="result-title-link" href="${escapeHtml(url)}" target="_blank" rel="noopener">${escapeHtml(title)}</a>`
                        : `<span class="result-title-link">${escapeHtml(title)}</span>`;

                    // ✅ Stop link click from also triggering card click
                    const viewSourceHtml = url
                        ? `<a href="${escapeHtml(url)}" target="_blank" rel="noopener" class="source-link" onclick="event.stopPropagation()">View Source ↗</a>`
                        : `<span style="color:#999; font-size:0.9rem">No URL mapped</span>`;

                    // ✅ Make whole card clickable if URL exists
                    const cardClick = url
                        ? `onclick="window.open('${escapeHtml(url)}','_blank')"`
                        : "";

                    html += `
                        <div class="result-card" ${cardClick}>
                            <div class="result-top">
                                <div>
                                    ${titleHtml}
                                    ${r.section_heading ? `<span class="badge">${escapeHtml(r.section_heading)}</span>` : ""}
                                </div>
                                ${viewSourceHtml}
                            </div>

                            <div class="result-meta">
                                ${source ? `<strong>Source:</strong> ${escapeHtml(source)}` : `<span style="color:#999">Source unknown</span>`}
                            </div>

                            <p class="result-snippet">${escapeHtml(snippet)}</p>
                        </div>
                    `;
                });

                html += `</div>`;
                resultsDiv.innerHTML = html;

            } catch (err) {
                resultsDiv.innerHTML = `<p style="color: red;">Error: ${err.message}</p>`;
            }
        }
    </script>
</body>
</html>
